@model cnu_cinema_practice.ViewModels.Sessions.SessionScheduleViewModel
@{
    ViewData["Title"] = "Session Schedule";
    Layout = "_Layout";
}

@section css {
    <link rel="stylesheet" href="~/css/session-schedule.css" />
}

<div class="schedule-container">
    <div class="schedule-header">
        <div class="schedule-title">
            <span>ðŸ“…</span> Session Schedule
        </div>
        <a asp-action="Create" class="btn btn-primary">+ New Session</a>
    </div>

    <div class="date-navigator">
        <button class="date-button" onclick="changeWeek(-1)">â€¹</button>
        @{
            var dates = Model.GetDatesInRange().ToList();
            foreach (var date in dates.Take(7))
            {
                var isActive = date.Date == Model.SelectedDate.Date;
                var dayName = date.ToString("ddd", new System.Globalization.CultureInfo("en-US")).ToUpper();
                <button class="date-button @(isActive ? "active" : "")"
                        onclick="selectDate('@date.ToString("yyyy-MM-dd")')">
                    <div>@dayName</div>
                    <div>@date.ToString("d.M")</div>
                </button>
            }
        }
        <button class="date-button" onclick="changeWeek(1)">â€º</button>
    </div>

    <div class="schedule-grid">
        <!-- Header row with times -->
        <div class="time-header">Halls</div>
        @for (int hour = 8; hour <= 24; hour++)
        {
            <div class="time-header">@($"{hour:00}:00")</div>
        }

        <!-- Rows for each hall -->
        @foreach (var hall in Model.Halls)
        {
            <div class="hall-row">
                <div class="hall-cell">@hall.Name</div>

                @for (int hour = 8; hour <= 24; hour++)
                {
                    <div class="schedule-cell">
                        @{
                            var sessionsInCell = Model.GetSessionsForHallAndDate(hall.Id, Model.SelectedDate)
                                .Where(s => s.StartTime.Hour == hour);

                            foreach (var session in sessionsInCell)
                            {
                                var startMinutes = session.StartTime.Minute;
                                var durationHours = session.MovieDuration / 60.0;
                                var widthInCells = durationHours;
                                var leftOffset = (startMinutes / 60.0) * 100;

                                <div class="session-block @session.GetOccupancyColorClass()"
                                     style="left: @(leftOffset)%; width: calc(@(widthInCells * 100)% - 10px);"
                                     onclick="window.location.href='@Url.Action("Details", new { id = session.Id })'">
                                    <div class="session-title">@session.MovieName</div>
                                    <div class="session-time">@session.StartTime.ToString("HH:mm")</div>
                                    <div class="session-info">@session.MovieFormat | @session.BasePriceâ‚´</div>
                                    <div class="session-occupancy">
                                        <span
                                            class="occupancy-indicator @(session.OccupancyPercentage >= 80 ? "indicator-red" : session.OccupancyPercentage >= 30 ? "indicator-yellow" : "indicator-green")"></span>
                                        @session.OccupiedSeats/@session.TotalSeats
                                    </div>
                                </div>
                            }
                        }
                    </div>
                }
            </div>
        }
    </div>

    <div class="legend">
        <div><strong>Legend:</strong></div>
        <div class="legend-item">
            <span class="occupancy-indicator indicator-green"></span>
            <span>Available (< 30%)</span>
        </div>
        <div class="legend-item">
            <span class="occupancy-indicator indicator-yellow"></span>
            <span>Filling (30-80%)</span>
        </div>
        <div class="legend-item">
            <span class="occupancy-indicator indicator-red"></span>
            <span>Almost Full (> 80%)</span>
        </div>
    </div>
</div>

<script>
    function selectDate(dateStr) {
        window.location.href = '@Url.Action("Schedule")?date=' + dateStr;
    }

    function changeWeek(direction) {
        var currentDate = new Date('@Model.SelectedDate.ToString("yyyy-MM-dd")');
        currentDate.setDate(currentDate.getDate() + (direction * 7));
        var newDate = currentDate.toISOString().split('T')[0];
        window.location.href = '@Url.Action("Schedule")?date=' + newDate;
    }
</script>

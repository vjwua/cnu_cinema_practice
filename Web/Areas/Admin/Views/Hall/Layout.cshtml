@using cnu_cinema_practice.ViewModels
@using Microsoft.EntityFrameworkCore.Storage.Json
@model cnu_cinema_practice.ViewModels.Halls.UpdateHallViewModel
@{
    ViewData["Title"] = "Hall Layout - " + Model.Name;
}

@section css {
    <link rel="stylesheet" href="~/css/halls.css" />
    <link rel="stylesheet" href="~/css/seats.css" />
}

<div class="mb-4">
    <h1 class="display-5">@Model.Name Layout</h1>
    <p class="text-muted">Configure seat availability and disabled seats</p>
</div>

<div class="row">
    <div class="col-lg-9">
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-grid-3x3"></i> Seat Configuration</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Click on seats to toggle their disabled status. Disabled seats cannot be booked by customers.
                </div>

                <!-- Screen -->
                <div class="text-center mb-4">
                    <div class="screen">SCREEN</div>
                </div>

                <!-- Seat Map -->
                <div class="seat-map">
                    @{
                        string[] seatClases =
                        [
                            "disabled-seat",
                            "standard-seat",
                            "premium-seat",
                            "vip-seat"
                        ];
                        List<string> DisabledSeats = new List<string>();
                        int rowCount = Model.SeatLayout.GetLength(0);
                        int columnCount = Model.SeatLayout.GetLength(1);
                        var rows = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".Substring(0, rowCount).ToCharArray();
                        string layoutString = "";
                        string resetString = "";

                        string hallName = Model.Name;
                        int hallId = Model.Id;
                        
                        for (int i = 0; i < rowCount; i++)
                        {
                            for (int j = 0; j < columnCount; j++)
                            {
                                layoutString += Model.SeatLayout[i, j].ToString();
                                resetString += "1";
                            }
                        }
                        for (int i = 0; i < rowCount; i++)
                        {
                            <div class="seat-row">
                                <span class="row-label">@rows[i]</span>
                                @for (int j = 1; j <= columnCount; j++)
                                {
                                    var seatId = $"{rows[i]}{j}";
                                    bool isDisabled = Model.SeatLayout[i, j - 1] == 0;
                                    if (isDisabled)
                                    {
                                        DisabledSeats.Add(seatId);
                                    }
                                    
                                    int r = i;
                                    int c = j - 1;
                                    
                                    <div class="seat @(seatClases[Model.SeatLayout[r, c]])"
                                         data-seat="@seatId"
                                         row="@r"
                                         column="@c"
                                         title="Seat @seatId - Click to toggle">
                                        @(c + 1)
                                    </div>
                                }
                                <span class="row-label">@rows[i]</span>
                            </div>
                        }
                    }
                </div>

                <!-- Legend -->
                <div class="seat-legend mt-4">
                    <div class="legend-item">
                        <div class="seat disabled-seat"></div>
                        <span>Unavailable</span>
                    </div>
                    <div class="legend-item">
                        <div class="seat standard-seat"></div>
                        <span>Standard</span>
                    </div>
                    <div class="legend-item">
                        <div class="seat premium-seat"></div>
                        <span>Premium</span>
                    </div>
                    <div class="legend-item">
                        <div class="seat vip-seat"></div>
                        <span>VIP</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3">
        <div class="card shadow-sm sticky-top" style="top: 20px;">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-tools"></i> Configuration</h5>
            </div>
            <div class="card-body">
                <h6>Unavailable Seats:</h6>
                <p id="disabled-seats-display" class="text-muted small">
                    @(DisabledSeats.Any() ? string.Join(", ", DisabledSeats) : "None")
                </p>

                <hr>

                <div class="mb-3">
                    <strong>Total Seats:</strong> @(rowCount * columnCount)<br>
                    <strong>Unavailable:</strong> <span id="disabled-count">@DisabledSeats.Count</span><br>
                    <strong>Available:</strong> <span id="available-count">@(rowCount * columnCount - DisabledSeats.Count)</span>
                </div>

                <hr>

                <form asp-action="UpdateLayout"
                      asp-route-id="@hallId"
                      asp-route-r="@rowCount"
                      asp-route-c="@columnCount"
                      method="post">
                    <input type="hidden" id="ls-input" name="ls" value="" />

                    <button type="submit" class="btn btn-success w-100 mb-2">
                        <i class="bi bi-save"></i> Save Layout
                    </button>
                </form>
                <form asp-action="ResetLayout"
                      asp-route-id="@hallId"
                      asp-route-name="@hallName"
                      asp-route-r="@rowCount"
                      asp-route-c="@columnCount"
                      method="post">
                    <button type="submit" class="btn btn-outline-secondary w-100 mb-2" id="reset-btn">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset 
                    </button>
                </form>
                <a asp-action="Index" class="btn btn-outline-dark w-100">
                    <i class="bi bi-arrow-left"></i> Back to Halls
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let disabledSeats = [];
            const totalSeats = @(Model.SeatLayout.GetLength(0) * Model.SeatLayout.GetLength(1));
            let ls = "@Model.Ls"
            const colCount = @Model.SeatLayout.GetLength(1);

            // Add click handlers to all seats
            document.querySelectorAll('.seat').forEach(seat => {
                if (seat.classList.contains("disabled-seat")) {
                    disabledSeats.push(seat.getAttribute("data-seat"))
                }
                seat.addEventListener('click', function() {
                    const seatId = this.getAttribute('data-seat');
                    let r = parseInt(this.getAttribute("row"))
                    let c = parseInt(this.getAttribute("column"))
                    let stringIndex = r * colCount + c
                    let lsEdit = "1"
                    
                    if (this.classList.contains('disabled-seat')) {
                        // Enable the seat
                        this.classList.remove('disabled-seat');
                        this.classList.add("standard-seat");
                        lsEdit = "1"
                        disabledSeats = disabledSeats.filter(s => s !== seatId);
                    } else  if (this.classList.contains("standard-seat")) {
                        // Disable the seat
                        this.classList.remove("standard-seat");
                        this.classList.add("premium-seat");
                        lsEdit = "2"
                    } else if (this.classList.contains("premium-seat")) {
                        this.classList.remove("premium-seat");
                        this.classList.add("vip-seat");
                        lsEdit = "3"
                    } else if (this.classList.contains("vip-seat")) {
                        this.classList.remove("vip-seat");
                        this.classList.add("disabled-seat");
                        lsEdit = "0"
                        disabledSeats.push(seatId);
                    }
                    let charLayout = ls.split("")
                    charLayout[stringIndex] = lsEdit
                    ls = charLayout.join("")

                    updateSummary();
                });

                seat.style.cursor = 'pointer';
            });

            updateSummary()

            function updateSummary() {
                const disabledCount = disabledSeats.length;
                const availableCount = totalSeats - disabledCount;

                document.getElementById('disabled-count').textContent = disabledCount;
                document.getElementById('available-count').textContent = availableCount;
                document.getElementById('ls-input').value = ls;

                if (disabledSeats.length > 0) {
                    disabledSeats.sort();
                    document.getElementById('disabled-seats-display').textContent = disabledSeats.join(', ');
                } else {
                    document.getElementById('disabled-seats-display').textContent = 'None';
                }
            }
        });
    </script>
}
@page "/"
@using cnu_cinema_practice.ViewModels.Home
@using Core.Interfaces.Services
@inject IMovieService MovieService
@rendermode RenderMode.InteractiveServer

<PageTitle>Головна - CNU Cinema</PageTitle>

<!-- === BACKGROUND AMBIENCE === -->
<div class="fixed-background" style="position: fixed; inset: 0; z-index: -1; pointer-events: none;">
    <div style="position: absolute; top: -20%; left: -10%; width: 60%; height: 60%; background: #0ea5e9; opacity: 0.1; filter: blur(150px); border-radius: 50%;"
        class="animate-blob"></div>
    <div style="position: absolute; bottom: -20%; right: -10%; width: 60%; height: 60%; background: #06b6d4; opacity: 0.1; filter: blur(150px); border-radius: 50%; animation-delay: -5s;"
        class="animate-blob"></div>
</div>

<!-- === CUSTOM NAVBAR === -->
<nav class="navbar-custom">
    <div class="container-custom flex-row justify-between items-center">
        <!-- Logo -->
        <a href="/" class="text-decoration-none flex-row items-center gap-3">
            <div class="nav-logo-box">
                <div class="nav-logo-glow"></div>
                <span class="text-white font-black">M</span>
            </div>
            <span class="text-xl font-black text-white text-uppercase italic tracking-widest">CineMaster</span>
        </a>

        <!-- Links -->
        <div class="hidden md-flex gap-5">
            <a @onclick="ScrollToGrid" class="text-decoration-none uppercase-nav hover-text-white transition-all"
                style="color: rgba(255,255,255,0.7); cursor: pointer;">Афіша</a>
            <a href="#" class="text-decoration-none uppercase-nav hover-text-white transition-all"
                style="color: rgba(255,255,255,0.7);">Кінотеатри</a>
            <a href="#" class="text-decoration-none uppercase-nav hover-text-white transition-all"
                style="color: rgba(255,255,255,0.7);">Новини</a>
        </div>

        <!-- Auth -->
        <a href="/Account/Login" class="btn-glass-hero text-decoration-none"
            style="padding: 0.6rem 1.5rem; font-size: 0.7rem; border-radius: 2rem;">
            Увійти
        </a>
    </div>
</nav>

<!-- === HERO SECTION === -->
@if (Model.FeaturedMovie != null)
{
    <section class="hero-section">
        <div class="hero-backdrop">
            @if (!string.IsNullOrEmpty(Model.FeaturedMovie.PosterUrl))
            {
                <img src="@Model.FeaturedMovie.PosterUrl" alt="@Model.FeaturedMovie.Name" />
            }
            <div class="hero-gradient"></div>
        </div>

        <div class="container-custom relative" style="z-index: 2;">
            <div class="flex-row">
                <div class="w-full md-flex flex-column items-start animate-fade-in" style="max-width: 800px;">
                    <div class="mb-4 flex-row items-center gap-3">
                        <span class="hero-badge">Рекомендовано</span>
                        <span class="text-white font-black tracking-widest text-uppercase" style="font-size: 0.8rem;">IMAX
                            Laser 4K</span>
                    </div>

                    <h1 class="hero-title">
                        @{
                            var titleParts = Model.FeaturedMovie.Name.Split(':');
                            if (titleParts.Length > 1)
                            {
                                <span class="block text-white">@titleParts[0]</span>
                                <span class="block text-cyan">@titleParts[1]</span>
                            }
                            else
                            {
                                <span class="block text-white">@Model.FeaturedMovie.Name</span>
                            }
                        }
                    </h1>

                    <p class="text-break mb-5 dynamic-description"
                        style="color: #cbd5e1; max-width: 600px; font-size: 1.1rem; line-height: 1.6;">
                        @Model.FeaturedMovie.Description
                    </p>

                    <div class="flex-row gap-3" style="flex-wrap: wrap;">
                        <button @onclick="ScrollToGrid" class="btn-primary-custom text-decoration-none">
                            Квитки від 160 ₴
                        </button>
                        <button class="btn-glass-hero">
                            Трейлер
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scroll Indicator -->
        <div class="scroll-indicator-wrapper">
            <span class="uppercase-nav mb-2" style="font-size: 0.6rem;">ПРОГОРНІТЬ</span>
            <div class="scroll-line"></div>
        </div>
    </section>
}

<!-- === MOVIES GRID SECTION === -->
<section id="movies-grid" class="container-custom pt-6 pb-5">
    <!-- Header & Filter -->
    <div class="d-flex flex-column md-row justify-between items-start md-items-center mb-5 gap-4">
        <div>
            <div class="flex-row items-center gap-2 mb-0">
                <div style="width: 30px; height: 2px; background: var(--cyan-500);"></div>
                <span class="text-cyan uppercase-nav" style="line-height: 1;">Зараз у прокаті</span>
            </div>
            <h2 class="font-heading text-white text-uppercase italic font-black m-0"
                style="font-size: 3rem; line-height: 0.9;">Обери фільм</h2>
        </div>

        <div class="genre-filter-container">
            <button class="genre-btn @(ActiveGenre == "all" ? "active" : "")"
            @onclick="@(() => SelectGenre("all"))">Всі</button>
            <button class="genre-btn @(ActiveGenre == "Action" ? "active" : "")"
            @onclick="@(() => SelectGenre("Action"))">Екшн</button>
            <button class="genre-btn @(ActiveGenre == "Drama" ? "active" : "")"
            @onclick="@(() => SelectGenre("Drama"))">Драма</button>
            <button class="genre-btn @(ActiveGenre == "Comedy" ? "active" : "")"
            @onclick="@(() => SelectGenre("Comedy"))">Комедія</button>
            <button class="genre-btn @(ActiveGenre == "SciFi" ? "active" : "")"
            @onclick="@(() => SelectGenre("SciFi"))">Фантастика</button>
        </div>
    </div>

    <!-- Grid -->
    <div class="movies-grid">
        @foreach (var movie in FilteredMovies)
        {
            <div class="movie-card-wrapper">
                <div class="movie-card">
                    <!-- Rating -->
                    <div class="rating-badge">
                        <span style="color: #fbbf24;">★</span>
                        <span>@movie.ImdbRating</span>
                    </div>

                    <!-- Image -->
                    @if (!string.IsNullOrEmpty(movie.PosterUrl))
                    {
                        <img src="@movie.PosterUrl" alt="@movie.Name" class="movie-poster" />
                    }
                    else
                    {
                        <div class="movie-poster flex-col justify-center items-center bg-card">
                            <span class="font-heading font-black text-muted" style="font-size: 3rem;">?</span>
                        </div>
                    }

                    <!-- Overlay Info -->
                    <div class="movie-overlay">
                        <div class="movie-info">
                            <h3 class="movie-title">@movie.Name</h3>
                            <div class="flex-row items-center gap-2 movie-meta">
                                <span>@movie.Genre</span>
                                <span style="font-size: 1.5rem; line-height: 0; color: var(--cyan-500);">•</span>
                                <span>@movie.FormattedDuration</span>
                            </div>

                            <!-- Sessions Preview -->
                            <div class="mt-4 pt-3 border-top"
                                style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                                <div class="uppercase-nav text-cyan mb-2" style="font-size: 0.6rem;">Сеанси</div>
                                <div class="flex-row gap-2" style="flex-wrap: wrap;">
                                    @foreach (var session in movie.Sessions.Take(2))
                                    {
                                        <div class="glass px-2 py-1 rounded font-black text-white"
                                            style="font-size: 0.7rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">
                                            @session.FormattedTime
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</section>

<!-- === COMING SOON SECTION === -->
@if (Model.UpcomingMovies.Any())
{
    <section class="container-custom pb-5 mt-5">
        <div class="mb-5">
            <div class="flex-row items-center gap-2 mb-0">
                <div style="width: 30px; height: 2px; background: var(--cyan-500);"></div>
                <span class="text-cyan uppercase-nav" style="line-height: 1;">Скоро</span>
            </div>
            <h2 class="font-heading text-white text-uppercase italic font-black m-0"
                style="font-size: 3rem; line-height: 0.9;">
                Очікуйте</h2>
        </div>

        <div class="movies-grid">
            @foreach (var movie in Model.UpcomingMovies.Take(4))
            {
                <div class="movie-card-wrapper">
                    <div class="movie-card" style="filter: grayscale(100%); transition: filter 0.5s;">
                        <div class="rating-badge">
                            <span class="text-cyan text-uppercase" style="font-size: 0.6rem;">Скоро</span>
                        </div>
                        @if (!string.IsNullOrEmpty(movie.PosterUrl))
                        {
                            <img src="@movie.PosterUrl" alt="@movie.Name" class="movie-poster" />
                        }
                        <div class="movie-overlay">
                            <div class="movie-info">
                                <h3 class="movie-title">@movie.Name</h3>
                                <div class="text-cyan font-black uppercase-nav">
                                    @movie.ReleaseDate.ToString("dd MMMM yyyy")
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </section>
}

@code {
    [Inject] IJSRuntime JS { get; set; } = default!;
    private HomeIndexViewModel Model { get; set; } = new();
    private string ActiveGenre { get; set; } = "all";

    private IEnumerable<MovieCardViewModel> FilteredMovies =>
    ActiveGenre == "all"
    ? Model.Movies
    : Model.Movies.Where(m => m.Genre.Contains(ActiveGenre, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        var moviesWithSessions = await MovieService.GetAllWithUpcomingSessionsAsync();

        var movieCards = moviesWithSessions.Select(movie => new MovieCardViewModel
            {
                Id = movie.Id,
                Name = movie.Name,
                PosterUrl = movie.PosterUrl,
                ImdbRating = movie.ImdbRating?.ToString("F1"),
                Genre = movie.Genre.ToString(),
                DurationMinutes = movie.DurationMinutes,
                Description = movie.Description ?? string.Empty,
                Sessions = movie.Sessions.Select(s => new MovieSessionTimeViewModel
                {
                    SessionId = s.Id,
                    StartTime = s.StartTime
                }).ToList()
            }).ToList();

        // Upcoming
        var upcomingMovies = await MovieService.GetUpcomingMoviesAsync();
        var upcomingViewModels = upcomingMovies.Select(m => new UpcomingMovieViewModel
            {
                Id = m.Id,
                Name = m.Name,
                PosterUrl = m.PosterUrl,
                Genre = m.Genre.ToString(),
                ImdbRating = m.ImdbRating,
                ReleaseDate = m.ReleaseDate,
                DurationMinutes = m.DurationMinutes
            }).ToList();

        Model = new HomeIndexViewModel
            {
                FeaturedMovie = movieCards.FirstOrDefault(),
                Movies = movieCards,
                UpcomingMovies = upcomingViewModels
            };
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("HomeHelpers.initHeroScroll");
        }
    }

    private async Task ScrollToGrid()
    {
        await JS.InvokeVoidAsync("HomeHelpers.scrollToElement", "movies-grid");
    }

    private void SelectGenre(string genre)
    {
        ActiveGenre = genre;
    }
}

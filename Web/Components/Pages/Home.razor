@page "/"
@rendermode @(new Microsoft.AspNetCore.Components.Web.InteractiveServerRenderMode())
@using cnu_cinema_practice.Models
@using cnu_cinema_practice.Services
@inject ICinemaService CinemaService
@inject IJSRuntime JS

<div class="min-h-screen relative text-slate-100 selection:bg-cyan-500/30">
    <!-- Background Ambience -->
    <div class="fixed inset-0 pointer-events-none -z-10 bg-[#020617]">
        <div class="absolute top-[-20%] left-[-10%] w-[70%] h-[70%] bg-cyan-950/20 blur-[180px] rounded-full animate-blob"></div>
        <div class="absolute bottom-[-20%] right-[-10%] w-[70%] h-[70%] bg-purple-900/10 blur-[180px] rounded-full animate-blob" style="animation-delay: -10s"></div>
    </div>

    <!-- Header -->
    <nav class="border-b border-white/5 bg-slate-950/20 backdrop-blur-3xl sticky top-0 z-[60]">
        <div class="container mx-auto px-6 py-5 flex justify-between items-center">
            <div @onclick="GoHome" class="flex items-center gap-4 cursor-pointer group">
                <div class="relative">
                    <div class="absolute inset-0 bg-cyan-500 blur-lg opacity-40 group-hover:opacity-100 transition-opacity"></div>
                    <div class="relative w-10 h-10 bg-slate-950 border border-white/10 rounded-xl flex items-center justify-center font-black text-xl text-white">M</div>
                </div>
                <span class="text-xl font-black tracking-tighter group-hover:text-cyan-400 transition-colors uppercase italic">CineMaster</span>
            </div>

            <div class="hidden md:flex gap-12 items-center">
                <button @onclick="ScrollToMovies"
                        class="text-[10px] font-black uppercase tracking-[0.3em] text-slate-500 hover:text-cyan-400 transition-colors">
                    –ê—Ñ—ñ—à–∞
                </button>
                <button @onclick="@(() => view = AppView.Cinemas)"
                        class="@($"text-[10px] font-black uppercase tracking-[0.3em] transition-colors {(view == AppView.Cinemas ? "text-cyan-400" : "text-slate-500 hover:text-white")}")">
                    –ö—ñ–Ω–æ—Ç–µ–∞—Ç—Ä–∏
                </button>
            </div>

            <button @onclick="@(() => view = AppView.Login)"
                    class="@($"glass px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest border border-white/10 hover:bg-white/5 transition-all {(view == AppView.Login ? "bg-cyan-500/10 border-cyan-500/50" : "")}")">
                –£–≤—ñ–π—Ç–∏
            </button>
        </div>
    </nav>

    <main class="relative z-10">
        @if (view == AppView.Grid)
        {
            <div class="animate-in fade-in duration-1000">
                <section id="banner-section" class="relative h-[85vh] w-full overflow-hidden flex items-end">
                    <div class="absolute inset-0 z-0">
                        <img src="@featuredMovie.Backdrop"
                             class="w-full h-full object-cover opacity-60 scale-105"
                             alt="Featured Movie Backdrop" />
                        <div class="absolute inset-0 bg-gradient-to-t from-[#020617] via-[#020617]/40 to-transparent"></div>
                        <div class="absolute inset-0 bg-gradient-to-r from-[#020617] via-transparent to-transparent"></div>
                    </div>

                    <div class="container mx-auto px-6 pb-20 relative z-10">
                        <div class="max-w-3xl space-y-6">
                            <div class="flex items-center gap-4 animate-in slide-in-from-left-8 duration-700">
                                <span class="px-3 py-1 bg-cyan-500 text-slate-950 font-black text-[10px] uppercase tracking-widest rounded">–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ</span>
                                <span class="text-slate-400 font-bold text-xs uppercase tracking-widest">IMAX Laser 4K</span>
                            </div>
                            <h1 class="text-7xl md:text-9xl font-black tracking-tighter uppercase italic leading-[0.85] animate-in slide-in-from-left-8 duration-700 delay-100 font-heading">
                                @{
                                    var parts = featuredMovie.Title.Split(':');
                                    for (int i = 0; i < parts.Length; i++)
                                    {
                                        <span class="@(i == 1 ? "text-cyan-400 block" : "block")">@parts[i]</span>
                                    }
                                }
                            </h1>
                            <p class="text-xl text-slate-300 max-w-xl font-medium animate-in slide-in-from-left-8 duration-700 delay-200">
                                @featuredMovie.Description
                            </p>
                            <div class="flex gap-4 pt-4 animate-in slide-in-from-left-8 duration-700 delay-300">
                                <button @onclick="() => HandleMovieSelect(featuredMovie)"
                                        class="px-10 py-5 bg-white text-slate-950 font-black uppercase tracking-widest text-sm rounded-2xl hover:bg-cyan-400 transition-all shadow-2xl shadow-white/5">
                                    –ö–≤–∏—Ç–∫–∏ –≤—ñ–¥ 160 ‚Ç¥
                                </button>
                                <button class="px-10 py-5 glass text-white font-black uppercase tracking-widest text-sm rounded-2xl hover:bg-white/5 transition-all">
                                    –¢—Ä–µ–π–ª–µ—Ä
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="absolute bottom-8 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2 opacity-30 animate-bounce">
                        <span class="text-[8px] font-black uppercase tracking-[0.3em]">–ü—Ä–æ–∫—Ä—É—Ç—ñ—Ç—å</span>
                        <div class="w-[1px] h-8 bg-gradient-to-b from-cyan-500 to-transparent"></div>
                    </div>
                </section>

                <section id="movies-section" @ref="moviesGridRef" class="container mx-auto px-6 py-20 scroll-mt-24">
                    <div class="flex flex-col md:flex-row justify-between items-end gap-8 mb-16">
                        <div class="space-y-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-[2px] bg-cyan-500"></div>
                                <span class="text-xs font-black uppercase tracking-[0.4em] text-cyan-500">–ó–∞—Ä–∞–∑ —É –ø—Ä–æ–∫–∞—Ç—ñ</span>
                            </div>
                            <h2 class="text-5xl font-black uppercase italic tracking-tighter font-heading">–û–±–µ—Ä–∏ —Å–≤—ñ–π —Ñ—ñ–ª—å–º</h2>
                        </div>

                        <div class="flex gap-2 p-1.5 glass rounded-2xl border border-white/5">
                            @foreach (var genre in genres)
                            {
                                <button @onclick="() => activeGenre = genre"
                                        class="@($"px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all {(activeGenre == genre ? "bg-cyan-500 text-slate-950 shadow-lg shadow-cyan-500/20" : "text-slate-500 hover:text-white")}")">
                                    @genre
                                </button>
                            }
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-10 gap-y-16">
                        @foreach (var movie in FilteredMovies)
                        {
                            <MovieCard Movie="movie" OnClick="HandleMovieSelect" />
                        }
                    </div>
                </section>
            </div>
        }

        @if (view == AppView.Cinemas)
        {
            <CinemasMap />
        }

        @if (view == AppView.Login)
        {
            <div class="min-h-[80vh] flex items-center justify-center p-6 animate-in fade-in zoom-in-95 duration-500">
                <div class="max-w-md w-full glass p-12 rounded-[3rem] border border-white/10 shadow-2xl relative overflow-hidden">
                    <div class="absolute -top-24 -right-24 w-48 h-48 bg-cyan-500/10 blur-[80px] rounded-full"></div>
                    <div class="relative z-10 space-y-10">
                        <div class="text-center space-y-2">
                            <h2 class="text-4xl font-black uppercase italic tracking-tighter font-heading">–í—ñ—Ç–∞—î–º–æ —É <span class="text-cyan-400">CineMaster</span></h2>
                            <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">–£–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –∫–µ—Ä—É–≤–∞—Ç–∏ –≤–∞—à–∏–º–∏ –∫–≤–∏—Ç–∫–∞–º–∏</p>
                        </div>

                        <form class="space-y-6" @onsubmit:preventDefault>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 ml-4">Email</label>
                                <input type="email" placeholder="cinema@master.com"
                                       class="w-full bg-slate-900/50 border border-white/5 px-6 py-4 rounded-2xl focus:outline-none focus:border-cyan-500/50 transition-colors" />
                            </div>
                            <div class="space-y-2">
                                <label class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 ml-4">–ü–∞—Ä–æ–ª—å</label>
                                <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                       class="w-full bg-slate-900/50 border border-white/5 px-6 py-4 rounded-2xl focus:outline-none focus:border-cyan-500/50 transition-colors" />
                            </div>
                            <button @onclick="GoHome"
                                    class="w-full bg-cyan-500 hover:bg-cyan-400 text-slate-950 font-black py-5 rounded-2xl transition-all shadow-xl shadow-cyan-500/20 uppercase tracking-widest text-xs">
                                –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏—Å—å
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        }

        @if (view == AppView.Booking)
        {
            <div class="max-w-6xl mx-auto px-6 py-12 animate-in fade-in slide-in-from-right-12 duration-700">
                <div class="flex justify-center mb-20">
                    <div class="flex items-center gap-0">
                        @for (int idx = 0; idx < stepsList.Count; idx++)
                        {
                            var s = stepsList[idx];
                            var isActive = step == s;
                            var isDone = stepsList.IndexOf(step) > idx;
                            var labels = new[] { "–§—ñ–ª—å–º", "–ú—ñ—Å—Ü—è", "–ë–∞—Ä", "–û–ø–ª–∞—Ç–∞" };

                            <div class="flex flex-col items-center group relative px-4">
                                <div class="@($"w-14 h-14 rounded-2xl flex items-center justify-center font-black transition-all duration-500 border-2 {(isDone ? "bg-cyan-500 border-cyan-500 text-slate-900" : isActive ? "border-cyan-400 text-cyan-400 shadow-[0_0_30px_rgba(34,211,238,0.3)] bg-cyan-400/5 rotate-6" : "border-slate-800 text-slate-700 bg-slate-900/40")}")">
                                    @(isDone ? "‚úì" : (idx + 1).ToString())
                                </div>
                                <span class="@($"absolute -bottom-8 whitespace-nowrap text-[10px] font-black uppercase tracking-[0.2em] transition-colors {(isActive ? "text-cyan-400" : "text-slate-600")}")">
                                    @(idx < labels.Length ? labels[idx] : "")
                                </span>
                            </div>
                            @if (idx < 3)
                            {
                                <div class="@($"w-16 h-[2px] rounded-full transition-colors duration-500 {(isDone ? "bg-cyan-500" : "bg-slate-800")}")"></div>
                            }
                        }
                    </div>
                </div>

                @if (step == BookingStep.Details && selectedMovie != null)
                {
                    <div class="flex flex-col lg:flex-row gap-20 items-start">
                        <div class="lg:w-2/5 group relative">
                            <div class="absolute -inset-4 bg-cyan-500/20 blur-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
                            <img src="@selectedMovie.Poster" class="relative w-full rounded-[2.5rem] shadow-2xl transition-transform duration-700 group-hover:scale-[1.02]" alt="@selectedMovie.Title" />

                            <div class="mt-8 glass p-8 rounded-[2rem] border border-white/10 space-y-6">
                                <div class="flex justify-between items-center pb-4 border-b border-white/5">
                                    <span class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500">–†–µ–∂–∏—Å–µ—Ä</span>
                                    <span class="font-bold text-sm text-cyan-400">@selectedMovie.Director</span>
                                </div>
                                <div class="space-y-3">
                                    <span class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 block">–£ –≥–æ–ª–æ–≤–Ω–∏—Ö —Ä–æ–ª—è—Ö</span>
                                    <div class="flex flex-wrap gap-2">
                                        @foreach (var actor in selectedMovie.Actors)
                                        {
                                            <span class="px-3 py-1 bg-white/5 border border-white/10 rounded-lg text-[10px] font-bold text-slate-300">@actor</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex-grow space-y-12">
                            <div>
                                <h2 class="text-7xl font-black mb-8 tracking-tighter uppercase italic leading-[0.9] font-heading">@selectedMovie.Title</h2>
                                <div class="flex flex-wrap gap-5 items-center">
                                    <div class="flex items-center gap-2 bg-amber-400 text-slate-950 font-black px-4 py-1.5 rounded-full text-sm">
                                        <span>‚≠ê</span> @selectedMovie.Rating
                                    </div>
                                    <span class="glass px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest text-slate-300 border border-white/10">@selectedMovie.AgeLimit</span>
                                    <span class="text-slate-500 font-bold uppercase text-xs tracking-widest">@string.Join(" / ", selectedMovie.Genre)</span>
                                    <span class="text-slate-500">‚Ä¢</span>
                                    <span class="text-slate-400 font-bold text-xs uppercase tracking-widest">@selectedMovie.Duration —Ö–≤</span>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <h3 class="text-[10px] font-black uppercase tracking-[0.3em] text-cyan-400">–ü—Ä–æ —Ñ—ñ–ª—å–º</h3>
                                <p class="text-xl text-slate-400 leading-relaxed font-light">@selectedMovie.Description</p>
                            </div>

                            <div class="space-y-8 p-10 glass rounded-[2.5rem]">
                                <h4 class="text-[10px] font-black uppercase tracking-[0.3em] text-cyan-400">–û–±–µ—Ä—ñ—Ç—å —Å–µ–∞–Ω—Å</h4>
                                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                                    @foreach (var sess in selectedMovie.Sessions)
                                    {
                                        <button @onclick="() => selectedSession = sess"
                                                class="@($"p-6 rounded-[2rem] border-2 transition-all group text-left {(selectedSession?.Id == sess.Id ? "border-cyan-400 bg-cyan-400/10 shadow-[0_0_20px_rgba(34,211,238,0.2)]" : "border-white/5 bg-slate-950/40 hover:border-slate-700")}")">
                                            <div class="@($"text-[9px] font-black uppercase mb-3 transition-colors {(selectedSession?.Id == sess.Id ? "text-cyan-400" : "text-slate-600")}")">
                                                @sess.HallType ‚Ä¢ @sess.HallName
                                            </div>
                                            <div class="text-3xl font-black mb-1 font-heading">@sess.Time</div>
                                            <div class="text-sm font-bold opacity-60">@sess.Price ‚Ç¥</div>
                                        </button>
                                    }
                                </div>
                            </div>

                            <button @onclick="@(() => step = BookingStep.Seats)"
                                    class="group relative w-full lg:w-auto overflow-hidden rounded-2xl">
                                <div class="absolute inset-0 bg-gradient-to-r from-cyan-500 to-blue-600 transition-transform duration-500 group-hover:scale-105"></div>
                                <div class="relative px-20 py-6 font-black uppercase tracking-widest text-white text-lg">–í–∏–±—Ä–∞—Ç–∏ –º—ñ—Å—Ü—è</div>
                            </button>
                        </div>
                    </div>
                }

                @if (step == BookingStep.Seats)
                {
                    <div class="grid lg:grid-cols-4 gap-16 items-start">
                        <div class="lg:col-span-3 glass rounded-[3rem] p-12 lg:p-20 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500/50 to-transparent"></div>
                            @if (selectedSession != null)
                            {
                                <SeatMap OccupiedSeats="@selectedSession.OccupiedSeats"
                                         SelectedSeats="@selectedSeats"
                                         OnSeatToggle="ToggleSeat" />
                            }
                        </div>
                        <div class="space-y-8 sticky top-32">
                            <div class="glass p-8 rounded-[2.5rem] relative overflow-hidden">
                                <h3 class="font-black uppercase tracking-[0.2em] text-[10px] text-slate-500 mb-8 flex items-center gap-2">
                                    <div class="w-1.5 h-1.5 rounded-full bg-cyan-500 animate-pulse"></div>
                                    –û–±—Ä–∞–Ω—ñ –º—ñ—Å—Ü—è
                                </h3>
                                <div class="space-y-5 mb-10 max-h-[300px] overflow-y-auto pr-2">
                                    @foreach (var s in selectedSeats)
                                    {
                                        <div class="flex justify-between items-center group animate-in slide-in-from-left-4">
                                            <div class="flex flex-col">
                                                <span class="text-sm font-black text-white">–†—è–¥ @(s.Split('-')[0]), –ú—ñ—Å—Ü–µ @(s.Split('-')[1])</span>
                                                <span class="text-[9px] text-cyan-500 uppercase font-black tracking-widest">@(int.Parse(s.Split('-')[0]) >= 7 ? "VIP" : "Standard")</span>
                                            </div>
                                            <span class="font-black text-white">@selectedSession?.Price ‚Ç¥</span>
                                        </div>
                                    }
                                </div>
                            </div>
                            <button disabled="@(selectedSeats.Count == 0)"
                                    @onclick="@(() => step = BookingStep.Snacks)"
                                    class="w-full bg-cyan-500 hover:bg-cyan-400 disabled:opacity-20 text-slate-950 font-black py-6 rounded-2xl transition-all shadow-2xl shadow-cyan-500/20 uppercase tracking-widest text-sm">
                                –î–æ –±–∞—Ä—É üçø
                            </button>
                        </div>
                    </div>
                }

                @if (step == BookingStep.Snacks)
                {
                    <div class="max-w-4xl mx-auto text-center">
                        <div class="mb-16">
                            <h2 class="text-6xl font-black mb-4 uppercase italic tracking-tighter font-heading">–°–Ω–µ–∫ <span class="text-cyan-400">–ë–∞—Ä</span></h2>
                            <p class="text-slate-500 font-black uppercase tracking-[0.4em] text-[10px]">–ó–∞–º–æ–≤–ª—è–π—Ç–µ –∑–∞—Ä–∞–∑ —Ç–∞ –∑–∞–±–∏—Ä–∞–π—Ç–µ –±–µ–∑ —á–µ—Ä–≥–∏</p>
                        </div>
                        <div class="mb-12">
                            <SnackSelector SelectedSnacks="@selectedSnacks" OnUpdateSnack="@UpdateSnack" />
                        </div>
                        <div class="flex flex-col sm:flex-row gap-6 justify-center items-center">
                            <button @onclick="@(() => step = BookingStep.Seats)" class="px-12 py-6 glass hover:bg-white/5 font-black rounded-2xl transition-all uppercase tracking-widest text-xs">–î–æ –∑–∞–ª—É</button>
                            <button @onclick="@(() => step = BookingStep.Checkout)"
                                    class="w-full sm:w-[350px] py-6 bg-cyan-500 hover:bg-cyan-400 text-slate-950 font-black rounded-2xl transition-all shadow-2xl shadow-cyan-500/20 uppercase tracking-widest text-sm">
                                –î–æ –æ–ø–ª–∞—Ç–∏ ‚Ä¢ @Totals.Total ‚Ç¥
                            </button>
                        </div>
                    </div>
                }

                @if (step == BookingStep.Checkout)
                {
                    <div class="max-w-md mx-auto glass p-12 rounded-[3rem] border border-white/10 shadow-2xl relative">
                        <h2 class="text-3xl font-black mb-12 text-center uppercase tracking-tighter italic font-heading">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è</h2>
                        <div class="space-y-8 mb-12">
                            <div class="flex justify-between items-end">
                                <div class="flex flex-col">
                                    <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">–ö–≤–∏—Ç–∫–∏ (@selectedSeats.Count)</span>
                                    <span class="font-bold">@selectedMovie?.Title</span>
                                </div>
                                <span class="font-black">@Totals.Seats ‚Ç¥</span>
                            </div>
                            <div class="pt-8 border-t border-white/5 flex justify-between items-center">
                                <span class="text-xl font-black uppercase italic text-cyan-400">–í—Å—å–æ–≥–æ</span>
                                <span class="text-5xl font-black text-white tracking-tighter font-heading">@Totals.Total ‚Ç¥</span>
                            </div>
                        </div>
                        <button @onclick="@(() => step = BookingStep.Ticket)" class="w-full bg-white text-slate-950 font-black py-6 rounded-2xl transition-all hover:bg-cyan-400 uppercase tracking-widest text-xs">–û–ø–ª–∞—Ç–∏—Ç–∏</button>
                    </div>
                }

                @if (step == BookingStep.Ticket)
                {
                    <div class="max-w-lg mx-auto glass rounded-[3rem] p-12 border border-white/10 text-center animate-in zoom-in-95">
                        <div class="w-24 h-24 bg-green-500 rounded-3xl flex items-center justify-center mx-auto mb-10 shadow-2xl shadow-green-500/30">
                            <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="4" d="M5 13l4 4L19 7"/></svg>
                        </div>
                        <h2 class="text-5xl font-black italic tracking-tighter uppercase mb-10 font-heading">–ö–≤–∏—Ç–æ–∫<br /><span class="text-cyan-400">–ê–∫—Ç–∏–≤–æ–≤–∞–Ω–æ</span></h2>
                        <div class="bg-white p-6 rounded-[2rem] inline-block mb-10">
                            <div class="w-48 h-48 bg-[url('https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=CINE-PREMIUM-00X')] bg-contain bg-center mix-blend-multiply opacity-90"></div>
                        </div>
                        <button @onclick="GoHome" class="w-full py-5 glass font-black uppercase tracking-widest text-xs rounded-2xl hover:bg-white/5 transition-all">–ó–∞–∫—Ä–∏—Ç–∏</button>
                    </div>
                }
            </div>
        }
    </main>

    <footer class="border-t border-white/5 py-20 mt-40 opacity-40">
        <div class="container mx-auto px-6 flex flex-col items-center gap-6">
            <div class="text-xs font-black uppercase tracking-[0.5em]">CINEMASTER PREMIUM EXPERIENCE</div>
            <p class="text-[8px] font-bold text-slate-700 mt-4">¬© 2024 –ú–ï–†–ï–ñ–ê –ö–Ü–ù–û–¢–ï–ê–¢–†–Ü–í –ù–û–í–û–ì–û –ü–û–ö–û–õ–Ü–ù–ù–Ø</p>
        </div>
    </footer>
</div>

@code {
    private AppView view = AppView.Grid;
    private BookingStep step = BookingStep.Details;
    private Movie? selectedMovie;
    private Session? selectedSession;
    private List<string> selectedSeats = new();
    private Dictionary<string, int> selectedSnacks = new();
    private string activeGenre = "–í—Å—ñ";
    private readonly List<string> genres = new() { "–í—Å—ñ", "–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞", "–ï–∫—à–Ω", "–î—Ä–∞–º–∞", "–ö–æ–º–µ–¥—ñ—è" };
    private ElementReference moviesGridRef;

    private List<Movie> Movies = new();
    private Movie featuredMovie => Movies.FirstOrDefault() ?? new Movie();

    // List for iterating steps
    private List<BookingStep> stepsList = new() { BookingStep.Details, BookingStep.Seats, BookingStep.Snacks, BookingStep.Checkout, BookingStep.Ticket };

    private IEnumerable<Movie> FilteredMovies =>
        activeGenre == "–í—Å—ñ" ? Movies : Movies.Where(m => m.Genre.Contains(activeGenre));

    private (decimal Seats, decimal Snacks, decimal Total) Totals
    {
        get
        {
            var seatPrice = selectedSeats.Count * (selectedSession?.Price ?? 0);
            var snacksPrice = selectedSnacks.Sum(kvp =>
            {
                var snack = MockData.Snacks.FirstOrDefault(s => s.Id == kvp.Key);
                return (snack?.Price ?? 0) * kvp.Value;
            });
            return (seatPrice, snacksPrice, seatPrice + snacksPrice);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Movies = await CinemaService.GetMoviesAsync();
        
        // Fallback to MockData if DB is empty to prevent blank screen during demo
        if (!Movies.Any())
        {
            Movies = MockData.Movies;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && view == AppView.Grid)
        {
            await JS.InvokeVoidAsync("initBannerScroll");
        }
    }

    private void HandleMovieSelect(Movie movie)
    {
        selectedMovie = movie;
        selectedSession = movie.Sessions.FirstOrDefault();
        view = AppView.Booking;
        step = BookingStep.Details;
        selectedSeats.Clear();
        selectedSnacks.Clear();
        // window.scrollTo(0,0) logic if needed via JS
    }

    private void GoHome()
    {
        view = AppView.Grid;
        selectedMovie = null;
        selectedSeats.Clear();
    }

    private async Task ScrollToMovies()
    {
        if (view != AppView.Grid)
        {
            view = AppView.Grid;
            await Task.Delay(100);
        }
        // Need JS Interop for scrollIntoView
        // await JS.InvokeVoidAsync("element.scrollIntoView", moviesGridRef);
    }

    private void ToggleSeat(string id)
    {
        if (selectedSeats.Contains(id))
            selectedSeats.Remove(id);
        else
            selectedSeats.Add(id);
    }

    private void UpdateSnack((string Id, int Delta) args)
    {
        if (!selectedSnacks.ContainsKey(args.Id))
            selectedSnacks[args.Id] = 0;
            
        selectedSnacks[args.Id] = Math.Max(0, selectedSnacks[args.Id] + args.Delta);
    }
}

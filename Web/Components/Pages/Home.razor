@using cnu_cinema_practice.ViewModels.Home
@using Microsoft.AspNetCore.Antiforgery
@layout HomeLayout
@rendermode RenderMode.InteractiveServer
@inject IAntiforgery Antiforgery
@inject IHttpContextAccessor HttpContextAccessor

<PageTitle>Головна - CNU Cinema</PageTitle>



<!-- === CUSTOM NAVBAR === -->
<nav class="navbar-custom">
    <div class="container-custom flex-row justify-between items-center">
        <!-- Logo -->
        <a href="/" class="text-decoration-none flex-row items-center gap-3">
            <div class="nav-logo-box">
                <div class="nav-logo-glow"></div>
                <span class="text-white font-black">M</span>
            </div>
            <span class="text-xl font-black text-white text-uppercase italic tracking-widest">CineMaster</span>
        </a>

        <!-- Links -->
        <div class="hidden md-flex gap-5">
            <a @onclick="ScrollToGrid" class="text-decoration-none uppercase-nav hover-text-white transition-all"
                style="color: rgba(255,255,255,0.7); cursor: pointer;">Афіша</a>
            <a href="#" class="text-decoration-none uppercase-nav hover-text-white transition-all"
                style="color: rgba(255,255,255,0.7);">Кінотеатри</a>
            <a href="#" class="text-decoration-none uppercase-nav hover-text-white transition-all"
                style="color: rgba(255,255,255,0.7);">Новини</a>
        </div>

        <!-- Auth -->
        <AuthorizeView>
            <Authorized>
                <div class="flex-row gap-3 items-center">
                    @if (context.User.IsInRole("Admin"))
                    {
                        <a href="/Admin/Dashboard" class="btn-glass-hero text-decoration-none"
                            style="padding: 0.6rem 1rem; font-size: 0.85rem; border-radius: 2rem; display: inline-flex; align-items: center; gap: 0.5rem;" 
                            title="Admin Panel">
                            <i class="bi bi-shield-lock" style="font-size: 1.1rem;"></i>
                        </a>
                    }
                    <a href="/Profile" class="btn-glass-hero profile-btn text-decoration-none"
                        style="padding: 0.6rem 1.2rem; font-size: 0.85rem; border-radius: 2rem; display: inline-flex; align-items: center; gap: 0.5rem;" 
                        title="@context.User.Identity?.Name">
                        <i class="bi bi-person-circle" style="font-size: 1.2rem;"></i>
                        <span style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@context.User.Identity?.Name</span>
                    </a>
                    <form action="/Account/Logout" method="post" style="margin: 0;">
                        <input type="hidden" name="__RequestVerificationToken" value="@GetAntiforgeryToken()" />
                        <button type="submit" class="btn-glass-hero logout-btn" 
                                style="padding: 0.6rem 1rem; font-size: 0.85rem; border-radius: 2rem; display: inline-flex; align-items: center; cursor: pointer;" 
                                title="Вийти">
                            <i class="bi bi-box-arrow-right" style="font-size: 1.1rem;"></i>
                        </button>
                    </form>
                </div>
            </Authorized>
            <NotAuthorized>
                <a href="/Account/Login" class="btn-glass-hero text-decoration-none"
                    style="padding: 0.6rem 1.5rem; font-size: 0.7rem; border-radius: 2rem;">
                    Увійти
                </a>
            </NotAuthorized>
        </AuthorizeView>
    </div>
</nav>

<!-- === HERO SECTION === -->
@if (Model.FeaturedMovie != null)
{
    <section class="hero-section">
        <div class="hero-backdrop">
            @if (!string.IsNullOrEmpty(Model.FeaturedMovie.PosterUrl))
            {
                <img src="@Model.FeaturedMovie.PosterUrl" alt="@Model.FeaturedMovie.Name" />
            }
            <div class="hero-gradient"></div>
        </div>

        <div class="container-custom relative" style="z-index: 2;">
            <div class="flex-row">
                <div class="w-full md-flex flex-column items-start animate-fade-in" style="max-width: 800px;">
                    <div class="mb-4 flex-row items-center gap-3">
                        <span class="hero-badge">Рекомендовано</span>
                        <span class="text-white font-black tracking-widest text-uppercase" style="font-size: 0.8rem;">IMAX
                            Laser 4K</span>
                    </div>

                    <h1 class="hero-title">
                        @{
                            var titleParts = Model.FeaturedMovie.Name.Split(':');
                            if (titleParts.Length > 1)
                            {
                                <span class="block text-white">@titleParts[0]</span>
                                <span class="block text-cyan">@titleParts[1]</span>
                            }
                            else
                            {
                                <span class="block text-white">@Model.FeaturedMovie.Name</span>
                            }
                        }
                    </h1>

                    <p class="text-break mb-5 dynamic-description"
                        style="color: #cbd5e1; max-width: 600px; font-size: 1.1rem; line-height: 1.6;">
                        @Model.FeaturedMovie.Description
                    </p>

                    <div class="flex-row gap-3" style="flex-wrap: wrap;">
                        <button @onclick="ScrollToGrid" class="btn-primary-custom text-decoration-none">
                            Квитки від 160 ₴
                        </button>
                        <button class="btn-glass-hero">
                            Трейлер
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scroll Indicator -->
        <div class="scroll-indicator-wrapper">
            <span class="uppercase-nav mb-2" style="font-size: 0.6rem;">ПРОГОРНІТЬ</span>
            <div class="scroll-line"></div>
        </div>
    </section>
}

<!-- === MOVIES GRID SECTION === -->
<section id="movies-grid" class="container-custom pt-6 pb-5">
    <!-- Header & Filter -->
    <div class="d-flex flex-column md-row justify-between items-start md-items-center mb-5 gap-4">
        <div>
            <div class="flex-row items-center gap-2 mb-0">
                <div style="width: 30px; height: 2px; background: var(--cyan-500);"></div>
                <span class="text-cyan uppercase-nav" style="line-height: 1;">Зараз у прокаті</span>
            </div>
            <h2 class="font-heading text-white text-uppercase italic font-black m-0"
                style="font-size: 3rem; line-height: 0.9;">Обери фільм</h2>
        </div>

        <div class="genre-filter-container">
            <button class="genre-btn @(ActiveGenre == "all" ? "active" : "")"
            @onclick="@(() => SelectGenre("all"))">Всі</button>
            <button class="genre-btn @(ActiveGenre == "Action" ? "active" : "")"
            @onclick="@(() => SelectGenre("Action"))">Екшн</button>
            <button class="genre-btn @(ActiveGenre == "Drama" ? "active" : "")"
            @onclick="@(() => SelectGenre("Drama"))">Драма</button>
            <button class="genre-btn @(ActiveGenre == "Comedy" ? "active" : "")"
            @onclick="@(() => SelectGenre("Comedy"))">Комедія</button>
            <button class="genre-btn @(ActiveGenre == "SciFi" ? "active" : "")"
            @onclick="@(() => SelectGenre("SciFi"))">Фантастика</button>
        </div>
    </div>

    <!-- Grid -->
    <div class="movies-grid">
        @foreach (var movie in FilteredMovies)
        {
            <div class="movie-card-wrapper">
                <div class="movie-card">
                    <!-- Rating -->
                    <div class="rating-badge">
                        <span style="color: #fbbf24;">★</span>
                        <span>@movie.ImdbRating</span>
                    </div>

                    <!-- Image -->
                    @if (!string.IsNullOrEmpty(movie.PosterUrl))
                    {
                        <img src="@movie.PosterUrl" alt="@movie.Name" class="movie-poster" />
                    }
                    else
                    {
                        <div class="movie-poster flex-col justify-center items-center bg-card">
                            <span class="font-heading font-black text-muted" style="font-size: 3rem;">?</span>
                        </div>
                    }

                    <!-- Overlay Info -->
                    <div class="movie-overlay">
                        <div class="movie-info">
                            <h3 class="movie-title">@movie.Name</h3>
                            <div class="flex-row items-center gap-2 movie-meta">
                                <span>@movie.Genre</span>
                                <span style="font-size: 1.5rem; line-height: 0; color: var(--cyan-500);">•</span>
                                <span>@movie.FormattedDuration</span>
                            </div>

                            <p class="movie-description">
                                @movie.Description
                            </p>

                            <!-- Sessions Preview -->
                            <div class="mt-2 pt-2 w-full flex-column items-center">
                                <div class="uppercase-nav text-cyan mb-2" style="font-size: 0.6rem;">Сеанси</div>
                                <div class="flex-row gap-2 justify-center" style="flex-wrap: wrap;">
                                    @foreach (var session in movie.Sessions.Take(2))
                                    {
                                        <div class="glass font-black text-white session-btn">
                                            @session.FormattedTime
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</section>

<!-- === COMING SOON SECTION === -->
@if (Model.UpcomingMovies.Any())
{
    <section class="container-custom pb-5 mt-5">
        <div class="flex-column gap-4 mb-5">
            <div class="flex-column gap-3">
                <div class="flex-row items-center gap-3">
                    <div class="section-header-line"></div>
                    <span class="section-header-label">Прем'єри незабаром</span>
                </div>
                <h2 class="section-header-title">Скоро у прокаті</h2>
            </div>
        </div>

        <div class="coming-soon-grid">
            @foreach (var movie in Model.UpcomingMovies.Take(4))
            {
                <div class="coming-soon-card">
                    <div class="coming-soon-card-inner">
                        @if (!string.IsNullOrEmpty(movie.PosterUrl))
                        {
                            <img src="@movie.PosterUrl" alt="@movie.Name" class="coming-soon-poster" />
                        }
                        <div class="coming-soon-overlay">
                            <div class="flex-column gap-3">
                                <div class="coming-soon-badge">Очікується</div>
                                <h3 class="coming-soon-title">@movie.Name</h3>
                                <p class="coming-soon-date">З @movie.ReleaseDate.ToString("dd MMMM")</p>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </section>
}

@code {
    [Inject] IJSRuntime JS { get; set; } = default!;

    [Parameter]
    public HomeIndexViewModel Model { get; set; } = new();

    private string ActiveGenre { get; set; } = "all";

    private IEnumerable<MovieCardViewModel> FilteredMovies =>
    Model?.Movies == null ? Enumerable.Empty<MovieCardViewModel>() :
    ActiveGenre == "all"
    ? Model.Movies
    : Model.Movies.Where(m => m.Genre.Contains(ActiveGenre, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("HomeHelpers.initHeroScroll");
        }
    }

    private async Task ScrollToGrid()
    {
        await JS.InvokeVoidAsync("HomeHelpers.scrollToElement", "movies-grid");
    }

    private void SelectGenre(string genre)
    {
        ActiveGenre = genre;
    }

    private string GetAntiforgeryToken()
    {
        var httpContext = HttpContextAccessor.HttpContext;
        if (httpContext == null) return string.Empty;
        
        var tokens = Antiforgery.GetAndStoreTokens(httpContext);
        return tokens.RequestToken ?? string.Empty;
    }
}
